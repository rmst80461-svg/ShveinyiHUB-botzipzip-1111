{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –®–≤–µ–π–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è{% endblock %}

{% block content %}
<div class="card">
    <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({{ users|length }})</h2>
    
    {% if users %}
    <style>
        .order-count { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: bold; 
            font-size: 13px;
            text-decoration: none;
        }
        .order-count-0 { background: #f0f0f0; color: #999; }
        .order-count-low { background: #e3f2fd; color: #1976d2; }
        .order-count-mid { background: #e8f5e9; color: #388e3c; }
        .order-count-high { background: #fff3e0; color: #f57c00; }
        .btn-admin {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        .btn-admin-add { background: #4CAF50; color: white; }
        .btn-admin-remove { background: #f44336; color: white; }
        .btn-admin:hover { opacity: 0.8; }
    </style>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Telegram ID</th>
                <th>–ò–º—è</th>
                <th>Username</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th>–ó–∞–∫–∞–∑–æ–≤</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            {% set count = order_counts.get(user.user_id, 0) %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.user_id }}</td>
                <td>{{ user.first_name or '-' }} {{ user.last_name or '' }}</td>
                <td>{% if user.username %}@{{ user.username }}{% else %}-{% endif %}</td>
                <td>{{ user.phone or '-' }}</td>
                <td>
                    {% if count == 0 %}
                    <span class="order-count order-count-0">0</span>
                    {% elif count <= 2 %}
                    <a href="/orders?user_id={{ user.user_id }}" class="order-count order-count-low">{{ count }}</a>
                    {% elif count <= 5 %}
                    <a href="/orders?user_id={{ user.user_id }}" class="order-count order-count-mid">{{ count }} ‚≠ê</a>
                    {% else %}
                    <a href="/orders?user_id={{ user.user_id }}" class="order-count order-count-high">{{ count }} üèÜ</a>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_blocked %}
                    <span class="status status-cancelled">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                    {% elif user.is_admin %}
                    <span class="status status-completed">üëë –ê–¥–º–∏–Ω</span>
                    {% else %}
                    <span class="status status-new">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '-' }}</td>
                <td>
                    {% if user.is_admin %}
                    <button class="btn-admin btn-admin-remove" onclick="toggleAdmin({{ user.user_id }})">–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞</button>
                    {% else %}
                    <button class="btn-admin btn-admin-add" onclick="toggleAdmin({{ user.user_id }})">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="padding: 20px; text-align: center; color: #888;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>
    {% endif %}
</div>

<script>
function toggleAdmin(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
    
    fetch('/api/users/' + userId + '/toggle-admin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}
</script>
{% endblock %}
